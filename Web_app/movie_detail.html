<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      background: black;
      color: white;
      font-family: "Times New Roman", serif;
      text-align: center;
      padding-top: 40px;
    }

    .back-top {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #FFF4B8;
      color: black;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 18px;
    }

    .back-top:hover {
      background: #B8E8FF;
    }

    .poster {
      width: 200px;
      border-radius: 16px;
      box-shadow: 0 0 12px rgba(255,255,255,0.15);
      margin-bottom: 20px;
    }

    .title {
      font-size: 32px;
      color: #FFF4B8;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .stars {
      font-size: 48px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .star {
      color: gray;
      transition: 0.2s;
    }

    .star.filled {
      color: #FFF4B8;
    }

    textarea {
      width: 350px;
      height: 120px;
      border-radius: 8px;
      margin-top: 20px;
      padding: 10px;
      font-family: "Times New Roman";
    }

    .button {
      background: gray;
      color: black;
      border-radius: 10px;
      padding: 12px 28px;
      font-size: 20px;
      cursor: not-allowed;
      margin-top: 25px;
      border: none;
    }

    .button.enabled {
      background: #FFF4B8;
      cursor: pointer;
    }

    .small-btn {
      background: #B8E8FF;
      color: black;
      padding: 8px 18px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    /* NEW - DELETE LINK */
    .delete-link {
      margin-top: 25px;
      color: gray;
      font-size: 18px;
      cursor: pointer;
      text-decoration: none;
    }

    .delete-link:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <a class="back-top" href="/watched">Back</a>

  <img id="poster" class="poster">
  <div id="movieTitle" class="title"></div>

  <div class="stars" id="starContainer">
    <span class="star" data-value="1">★</span>
    <span class="star" data-value="2">★</span>
    <span class="star" data-value="3">★</span>
    <span class="star" data-value="4">★</span>
    <span class="star" data-value="5">★</span>
  </div>

  <form id="saveForm" action="/save-movie" method="POST">
    <input type="hidden" id="watched_id" name="watched_id">
    <input type="hidden" id="rating" name="rating">

    <div id="reviewSection"></div>

    <button id="saveBtn" class="button" disabled>Save Changes</button>
  </form>

  <!-- NEW DELETE BUTTON -->
  <div class="delete-link" onclick="confirmDelete()">Un-watch</div>

  <script>
    let selectedRating = 0;
    const stars = document.querySelectorAll(".star");
    const ratingInput = document.getElementById("rating");
    const saveBtn = document.getElementById("saveBtn");

    const params = window.location.pathname.split("/");
    const watched_id = params[2];
    document.getElementById("watched_id").value = watched_id;

    fetch("/api/movie/" + watched_id)
      .then(res => res.json())
      .then(movie => {
        document.getElementById("poster").src = movie.poster_full_url;
        document.getElementById("movieTitle").innerText = movie.movie_title;

        selectedRating = movie.user_rating;
        ratingInput.value = selectedRating;
        highlightStars(selectedRating);

        const reviewSection = document.getElementById("reviewSection");

        if (movie.review) {
          reviewSection.innerHTML = `
            <textarea name="review" id="reviewBox" disabled>${movie.review}</textarea>
            <br>
            <button type="button" class="small-btn" onclick="enableReview()">Edit Review</button>
          `;
        } else {
          reviewSection.innerHTML = `
            <button type="button" class="small-btn" onclick="showReviewBox()">Leave a Review</button>
            <br>
            <textarea name="review" id="reviewBox" style="display:none;"></textarea>
          `;
        }

        saveBtn.classList.add("enabled");
        saveBtn.disabled = false;
      });

    function highlightStars(count) {
      stars.forEach(star => {
        star.classList.toggle("filled", star.dataset.value <= count);
      });
    }

    stars.forEach(star => {
      star.addEventListener("mouseover", () => highlightStars(star.dataset.value));
      star.addEventListener("mouseout", () => highlightStars(selectedRating));
      star.addEventListener("click", () => {
        selectedRating = star.dataset.value;
        ratingInput.value = selectedRating;
        highlightStars(selectedRating);
        saveBtn.classList.add("enabled");
        saveBtn.disabled = false;
      });
    });

    function enableReview() {
      document.getElementById("reviewBox").disabled = false;
      saveBtn.classList.add("enabled");
      saveBtn.disabled = false;
    }

    function showReviewBox() {
      const box = document.getElementById("reviewBox");
      box.style.display = "block";
      saveBtn.classList.add("enabled");
      saveBtn.disabled = false;
    }

    // NEW — DELETE MOVIE INTERACTION
    function confirmDelete() {
      const confirmed = confirm("Are you sure you want to un-watch this movie?");
      if (!confirmed) return;

      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/delete-movie";

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "watched_id";
      input.value = watched_id;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  </script>

</body>
</html>
